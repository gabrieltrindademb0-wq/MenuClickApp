<!doctype html>
<html lang="pt-br" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Entrar (Parceiro) - MenuClick</title>
  <link rel="stylesheet" href="./css/styles.css"/>
  <link rel="stylesheet" href="./css/auth.css"/>
</head>
<body class="auth">
  <div class="authWrap">
    <div class="authCard">
      <section class="authHero">
        <div class="brandRow">
          <div class="logoDot">üè™</div>
          <strong>MenuClick</strong><span class="badge">Parceiro</span>
        </div>
        <h2>Bem-vindo de volta</h2>
        <p>Entre para gerenciar sua loja, produtos e pedidos.</p>
        <ul>
          <li>Use <b>e-mail</b> ou <b>WhatsApp</b> para entrar</li>
          <li>Recupera√ß√£o de senha em 1 clique</li>
          <li>Se sua loja estiver em <b>an√°lise</b>, voc√™ ver√° o status aqui</li>
        </ul>

        <div style="margin-top:14px; padding:12px; border-radius:14px; border:1px solid var(--border); background: rgba(226,93,27,.08)">
          <b>Como funciona a aprova√ß√£o</b>
          <div style="color:var(--muted); margin-top:6px; line-height:1.5">
            Ap√≥s o cadastro, analisamos os dados (at√© <b>24h</b>). Quando aprovado, voc√™ recebe aviso no <b>e-mail</b> e <b>WhatsApp</b> cadastrados.
          </div>
        </div>
      </section>

      <section class="authPanel">
        <div class="topRow">
          <div>
            <h1>Entrar</h1>
            <p class="sub">Acesse sua conta de parceiro.</p>
          </div>
          <button class="btnIcon" id="themeToggle" title="Tema" aria-label="Tema" type="button" data-icon>üåô</button>
        </div>

        <div class="formGrid one">
          <div class="field">
            <label>E-mail ou WhatsApp</label>
            <input class="input" id="identifier" placeholder="seu@email.com ou (DD) 9xxxx-xxxx" autocomplete="username"/>
          </div>

          <div class="field">
            <label>Senha</label>
            <input class="input" id="password" type="password" placeholder="Sua senha" autocomplete="current-password"/>
          </div>

          <div class="rowBetween">
            <button class="linkBtn" id="btnForgot" type="button">Esqueceu a senha?</button>
            <a href="lojista-signup.html" style="text-decoration:underline; font-weight:650">Cadastrar loja</a>
          </div>

          <button class="btn btnAccent" id="btnLogin" type="button" style="width:100%; margin-top:10px">Entrar</button>
        </div>

        <p class="smallNote">
          √â cliente? <a href="login-cliente.html">Entrar como cliente</a>.
        </p>
      </section>
    </div>
  </div>

  <script type="module">
    import { loginUser, checkLoginStatus, resetPassword, isValidEmail, isValidPhoneBR, isLikelyEmail, logoutTo } from "./js/auth.js";
    import { db } from "./js/firebase.js";
<<<<<<< HEAD
    import { doc, getDoc, collection, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
=======
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
>>>>>>> 8ee44a8102a50acf158227eb3876dcab5067988f
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { initThemeToggle } from "./js/theme.js";

    initThemeToggle();
    checkLoginStatus(false);

    const auth = getAuth();
    const val = (v) => (v || "").trim();

    // Recupera√ß√£o (somente e-mail)
    document.getElementById("btnForgot").onclick = async () => {
      const id = val(document.getElementById("identifier").value).toLowerCase();
      if(!id) return alert("Digite seu e-mail no campo acima para recuperar a senha.");
      if(!isLikelyEmail(id)) return alert("Para recuperar a senha, informe seu e-mail (n√£o WhatsApp).");
      if(!isValidEmail(id)) return alert("E-mail inv√°lido.");

      try{
        await resetPassword(id);
        alert("Enviamos um e-mail de recupera√ß√£o. Verifique sua caixa de entrada e spam.");
      }catch(e){
        console.error(e);
        alert("N√£o foi poss√≠vel enviar o e-mail de recupera√ß√£o.");
      }
    };

    // Login
    document.getElementById("btnLogin").onclick = async () => {
      const identifier = val(document.getElementById("identifier").value);
      const pass = document.getElementById("password").value || "";

      if(!identifier) return alert("Digite seu e-mail ou WhatsApp.");

      if(isLikelyEmail(identifier)){
        if(!isValidEmail(identifier)) return alert("E-mail inv√°lido.");
      } else {
        if(!isValidPhoneBR(identifier)) return alert("WhatsApp inv√°lido. Use DDD + n√∫mero.");
      }

      if(pass.length < 6) return alert("Senha inv√°lida.");

      try{
        await loginUser(identifier, pass);
<<<<<<< HEAD
        // Redirecionamento expl√≠cito + verifica√ß√£o de aprova√ß√£o pela loja (restaurants)
        const uid = auth.currentUser?.uid;
        if(!uid) throw new Error("NO_UID");

        // 1) Confere se √© conta de lojista
        const userSnap = await getDoc(doc(db, "users", uid));
        const userData = userSnap.exists() ? userSnap.data() : {};
        if(userData.role !== "owner"){
          await logoutTo("login-lojista.html");
          return alert("Essa conta √© de cliente. Entre pela √°rea de cliente.");
        }

        // 2) Fonte de verdade: restaurants.approvalStatus + restaurants.isActive
        const rq = query(collection(db, "restaurants"), where("ownerId", "==", uid), limit(1));
        const rs = await getDocs(rq);
        if(rs.empty){
          // ainda n√£o tem loja vinculada
          window.location.href = "analise.html";
          return;
        }

        const r = rs.docs[0].data() || {};
        const approved = (r.approvalStatus === "approved") && (r.isActive === true);
        window.location.href = approved ? "admin-dashboard.html" : "analise.html";
=======
        // Redirecionamento expl√≠cito (evita cair na √°rea do cliente por engano)
        try{
          const uid = auth.currentUser?.uid;
          if(!uid) throw new Error("NO_UID");
          const snap = await getDoc(doc(db, "users", uid));
          const data = snap.exists() ? snap.data() : {};
          if(data.role !== "owner"){
            await logoutTo("login-lojista.html");
            return alert("Essa conta √© de cliente. Entre pela √°rea de cliente.");
          }
          window.location.href = "admin-dashboard.html";
        }catch(e2){
          console.error(e2);
          // fallback: deixa o checkLoginStatus decidir
        }
>>>>>>> 8ee44a8102a50acf158227eb3876dcab5067988f
      }catch(e){
        console.error(e);
        alert("Erro ao entrar. Verifique seus dados.");
      }
    };
  </script>
</body>
</html>
